<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å…·é»å­˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#f3f4f6'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* QR Scanner Styles */
        #qr-video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
        }
        
        .scanner-container {
            position: relative;
            display: inline-block;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #5D5CDE;
            border-radius: 12px;
            pointer-events: none;
        }

        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 12px;
            animation: scanner-pulse 2s infinite;
        }

        @keyframes scanner-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .drag-area {
            border: 3px dashed #5D5CDE;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .drag-area.dragover {
            border-color: #4338ca;
            background-color: rgba(93, 92, 222, 0.1);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">ğŸ“‹ æ•™å…·é»å­˜ç³»çµ±</h1>
            <p class="text-gray-600 dark:text-gray-400">æƒæQR codeé€²è¡Œæ•™å…·é»å­˜ç®¡ç†</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <!-- QR Scanner Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <span class="text-2xl mr-2">ğŸ“±</span>
                        QR Code æƒæ
                    </h2>
                    <button id="switchCameraBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 hidden">
                        åˆ‡æ›ç›¸æ©Ÿ
                    </button>
                </div>
                
                <!-- Camera Scanner -->
                <div id="cameraSection" class="mb-4">
                    <div class="scanner-container text-center mb-4">
                        <video id="qr-video" class="hidden"></video>
                        <div class="scanner-overlay hidden"></div>
                    </div>
                    <div class="flex justify-center space-x-3">
                        <button id="startCameraBtn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ
                        </button>
                        <button id="stopCameraBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors hidden">
                            â¹ï¸ åœæ­¢æƒæ
                        </button>
                    </div>
                </div>

                <!-- Image Upload Fallback -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 text-center">æˆ–ä¸Šå‚³QR codeåœ–ç‰‡</p>
                    <div class="drag-area p-6 text-center" id="dragArea">
                        <div class="text-3xl mb-2">ğŸ“·</div>
                        <p class="text-gray-600 dark:text-gray-400 mb-3">æ‹–æ”¾åœ–ç‰‡æˆ–é»æ“Šé¸æ“‡</p>
                        <input type="file" id="qrImageInput" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('qrImageInput').click()" 
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            é¸æ“‡åœ–ç‰‡
                        </button>
                    </div>
                </div>

                <!-- Scan Result -->
                <div id="scanResult" class="hidden mt-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 dark:text-green-400 mb-2">æƒæçµæœï¼š</h3>
                    <p id="scanResultText" class="text-green-700 dark:text-green-300 break-all"></p>
                </div>
            </section>

            <!-- CSV Management Section -->
            <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ“„</span>
                    CSV è³‡æ–™ç®¡ç†
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">åŒ¯å…¥æ•™å…·æ¸…å–®</label>
                        <input type="file" id="csvInput" accept=".csv" 
                               class="w-full text-base px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">CSVæ ¼å¼ï¼šç·¨è™Ÿ,æ•™å…·åç¨±</p>
                    </div>
                    
                    <button id="exportBtn" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸ“¥ åŒ¯å‡ºé»å­˜è¨˜éŒ„
                    </button>
                    
                    <button id="clearRecordsBtn" 
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        ğŸ—‘ï¸ æ¸…ç©ºé»å­˜è¨˜éŒ„
                    </button>

                    <button id="clearAllBtn" 
                            class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        âŒ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                    </button>
                </div>
            </section>
        </div>

        <!-- Tools List Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <span class="text-2xl mr-2">ğŸ“‹</span>
                    æ•™å…·æ¸…å–®
                </h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">
                    ç¸½è¨ˆï¼š<span id="totalCount" class="font-semibold">0</span> ä»¶
                </span>
            </div>

            <!-- Search -->
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="æœå°‹æ•™å…·åç¨±æˆ–ç·¨è™Ÿ..." 
                       class="w-full text-base px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
            </div>

            <!-- Tools Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">ç·¨è™Ÿ</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·åç¨±</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">é»å­˜æ¬¡æ•¸</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æœ€å¾Œé»å­˜æ™‚é–“</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="toolsList">
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡æ•™å…·è³‡æ–™ï¼Œè«‹åŒ¯å…¥CSVæª”æ¡ˆ
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Records Section -->
        <section class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“Š</span>
                é»å­˜è¨˜éŒ„
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ™‚é–“</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·ç·¨è™Ÿ</th>
                            <th class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-left">æ•™å…·åç¨±</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceList">
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡é»å­˜è¨˜éŒ„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // === Configuration ===
        const CONFIG = {
            QR_SCANNER_OPTIONS: {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
            }
        };

        // === State Management ===
        class AppState {
            constructor() {
                this.tools = [];
                this.attendanceRecords = [];
                this.scanner = null;
                this.isScanning = false;
            }

            // Tools management
            setTools(tools) {
                this.tools = tools;
                this.renderToolsList();
            }

            findTool(id) {
                return this.tools.find(tool => tool.id === id);
            }

            // Attendance management
            addAttendanceRecord(toolId, toolName) {
                const record = {
                    timestamp: new Date().toLocaleString('zh-TW'),
                    toolId: toolId,
                    toolName: toolName
                };
                
                this.attendanceRecords.unshift(record);
                
                // Update tool's attendance count
                const tool = this.findTool(toolId);
                if (tool) {
                    tool.attendanceCount = (tool.attendanceCount || 0) + 1;
                    tool.lastAttendance = record.timestamp;
                }

                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAttendanceRecords() {
                this.attendanceRecords = [];
                // Reset tools attendance data
                this.tools.forEach(tool => {
                    tool.attendanceCount = 0;
                    tool.lastAttendance = '';
                });
                this.renderToolsList();
                this.renderAttendanceList();
            }

            clearAll() {
                this.tools = [];
                this.attendanceRecords = [];
                this.renderToolsList();
                this.renderAttendanceList();
            }

            // Rendering methods
            renderToolsList(searchTerm = '') {
                ToolsListRenderer.render(this.tools, searchTerm);
            }

            renderAttendanceList() {
                AttendanceRenderer.render(this.attendanceRecords);
            }
        }

        // === QR Scanner Module ===
        class QRScannerModule {
            constructor(appState) {
                this.appState = appState;
                this.scanner = null;
                this.isScanning = false;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Camera controls
                document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCameraBtn').addEventListener('click', () => this.stopCamera());
                document.getElementById('switchCameraBtn').addEventListener('click', () => this.switchCamera());

                // Image upload
                const qrImageInput = document.getElementById('qrImageInput');
                const dragArea = document.getElementById('dragArea');
                
                qrImageInput.addEventListener('change', (e) => this.handleImageUpload(e));
                
                // Drag and drop
                dragArea.addEventListener('click', () => qrImageInput.click());
                dragArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                dragArea.addEventListener('dragleave', () => this.handleDragLeave());
                dragArea.addEventListener('drop', (e) => this.handleDrop(e));
            }

            async startCamera() {
                try {
                    const video = document.getElementById('qr-video');
                    const overlay = document.querySelector('.scanner-overlay');
                    const startBtn = document.getElementById('startCameraBtn');
                    const stopBtn = document.getElementById('stopCameraBtn');
                    const switchBtn = document.getElementById('switchCameraBtn');

                    this.scanner = new QrScanner(
                        video,
                        (result) => this.handleScanResult(result),
                        CONFIG.QR_SCANNER_OPTIONS
                    );

                    await this.scanner.start();
                    
                    // Update UI
                    video.classList.remove('hidden');
                    overlay.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    switchBtn.classList.remove('hidden');
                    
                    this.isScanning = true;
                    MessageHandler.show('ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹å°‡QR codeå°æº–æƒæå€åŸŸ', 'success');
                    
                } catch (error) {
                    console.error('Camera access failed:', error);
                    MessageHandler.show('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šæˆ–ä½¿ç”¨åœ–ç‰‡ä¸Šå‚³åŠŸèƒ½', 'error');
                }
            }

            stopCamera() {
                if (this.scanner) {
                    this.scanner.stop();
                    this.scanner.destroy();
                    this.scanner = null;
                }

                // Update UI
                const video = document.getElementById('qr-video');
                const overlay = document.querySelector('.scanner-overlay');
                const startBtn = document.getElementById('startCameraBtn');
                const stopBtn = document.getElementById('stopCameraBtn');
                const switchBtn = document.getElementById('switchCameraBtn');

                video.classList.add('hidden');
                overlay.classList.add('hidden');
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                switchBtn.classList.add('hidden');

                this.isScanning = false;
                MessageHandler.show('ç›¸æ©Ÿå·²åœæ­¢', 'info');
            }

            async switchCamera() {
                if (this.scanner) {
                    try {
                        await this.scanner.setCamera('environment');
                        MessageHandler.show('å·²åˆ‡æ›ç›¸æ©Ÿ', 'info');
                    } catch (error) {
                        console.error('Switch camera failed:', error);
                        MessageHandler.show('åˆ‡æ›ç›¸æ©Ÿå¤±æ•—', 'error');
                    }
                }
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processImageFile(file);
                }
            }

            handleDragOver(event) {
                event.preventDefault();
                document.getElementById('dragArea').classList.add('dragover');
            }

            handleDragLeave() {
                document.getElementById('dragArea').classList.remove('dragover');
            }

            handleDrop(event) {
                event.preventDefault();
                document.getElementById('dragArea').classList.remove('dragover');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    this.processImageFile(files[0]);
                }
            }

            async processImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    MessageHandler.show('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'error');
                    return;
                }

                try {
                    const result = await QrScanner.scanImage(file);
                    this.handleScanResult(result);
                } catch (error) {
                    console.error('QR scan failed:', error);
                    MessageHandler.show('ç„¡æ³•è­˜åˆ¥QR Codeï¼Œè«‹ç¢ºèªåœ–ç‰‡æ¸…æ™°åº¦', 'error');
                }
            }

            handleScanResult(result) {
                const qrData = typeof result === 'string' ? result : result.data;
                
                // Display result
                document.getElementById('scanResultText').textContent = qrData;
                document.getElementById('scanResult').classList.remove('hidden');
                
                // Process the scan
                AttendanceProcessor.process(qrData.trim(), this.appState);
            }
        }

        // === CSV Module ===
        class CSVModule {
            constructor(appState) {
                this.appState = appState;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('csvInput').addEventListener('change', (e) => this.handleImport(e));
                document.getElementById('exportBtn').addEventListener('click', () => this.exportAttendance());
                document.getElementById('clearRecordsBtn').addEventListener('click', () => this.clearRecords());
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAll());
            }

            handleImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            MessageHandler.show('CSVæª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                            return;
                        }

                        const tools = results.data
                            .map(row => ({
                                id: (row.ç·¨è™Ÿ || row.id || '').toString().trim(),
                                name: (row.æ•™å…·åç¨± || row.name || '').toString().trim(),
                                attendanceCount: 0,
                                lastAttendance: ''
                            }))
                            .filter(tool => tool.id && tool.name);

                        this.appState.setTools(tools);
                        MessageHandler.show(`æˆåŠŸåŒ¯å…¥ ${tools.length} ä»¶æ•™å…·`, 'success');
                    },
                    error: (error) => {
                        console.error('CSV parse error:', error);
                        MessageHandler.show('è®€å–CSVæª”æ¡ˆå¤±æ•—', 'error');
                    }
                });
            }

            exportAttendance() {
                if (this.appState.attendanceRecords.length === 0) {
                    MessageHandler.show('æ²’æœ‰é»å­˜è¨˜éŒ„å¯ä»¥åŒ¯å‡º', 'error');
                    return;
                }

                const csvData = this.appState.attendanceRecords.map(record => ({
                    æ™‚é–“: record.timestamp,
                    æ•™å…·ç·¨è™Ÿ: record.toolId,
                    æ•™å…·åç¨±: record.toolName
                }));

                const csv = Papa.unparse(csvData);
                this.downloadCSV(csv, `é»å­˜è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`);
                MessageHandler.show('é»å­˜è¨˜éŒ„å·²ä¸‹è¼‰', 'success');
            }

            clearRecords() {
                if (this.showConfirmDialog('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é»å­˜è¨˜éŒ„å—ï¼Ÿæ•™å…·æ¸…å–®å°‡ä¿ç•™ã€‚')) {
                    this.appState.clearAttendanceRecords();
                    MessageHandler.show('é»å­˜è¨˜éŒ„å·²æ¸…ç©º', 'success');
                }
            }

            clearAll() {
                if (this.showConfirmDialog('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    this.appState.clearAll();
                    MessageHandler.show('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º', 'success');
                }
            }

            downloadCSV(csvContent, filename) {
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showConfirmDialog(message) {
                return confirm(message);
            }
        }

        // === Attendance Processor ===
        class AttendanceProcessor {
            static process(qrData, appState) {
                const toolId = qrData;
                const tool = appState.findTool(toolId);

                if (tool) {
                    appState.addAttendanceRecord(toolId, tool.name);
                    MessageHandler.show(`âœ… ${tool.name} é»å­˜æˆåŠŸ`, 'success');
                } else {
                    MessageHandler.show(`âŒ æ‰¾ä¸åˆ°ç·¨è™Ÿç‚º "${toolId}" çš„æ•™å…·`, 'error');
                }
            }
        }

        // === Renderers ===
        class ToolsListRenderer {
            static render(tools, searchTerm = '') {
                const toolsList = document.getElementById('toolsList');
                const totalCount = document.getElementById('totalCount');

                let filteredTools = tools;
                if (searchTerm) {
                    filteredTools = tools.filter(tool => 
                        tool.id.toLowerCase().includes(searchTerm.toLowerCase()) || 
                        tool.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }

                totalCount.textContent = filteredTools.length;

                if (filteredTools.length === 0) {
                    toolsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                ${searchTerm ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ•™å…·' : 'å°šç„¡æ•™å…·è³‡æ–™ï¼Œè«‹åŒ¯å…¥CSVæª”æ¡ˆ'}
                            </td>
                        </tr>
                    `;
                    return;
                }

                toolsList.innerHTML = filteredTools.map(tool => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${tool.id}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${tool.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-center">
                            <span class="px-2 py-1 rounded-full text-sm font-medium ${
                                (tool.attendanceCount || 0) > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 
                                'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                            }">
                                ${tool.attendanceCount || 0}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">
                            ${tool.lastAttendance || '-'}
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">
                            <button onclick="attendanceProcessor.process('${tool.id}', appState)" 
                                    class="bg-primary text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                ğŸ“ æ‰‹å‹•é»å­˜
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        class AttendanceRenderer {
            static render(records) {
                const attendanceList = document.getElementById('attendanceList');

                if (records.length === 0) {
                    attendanceList.innerHTML = `
                        <tr>
                            <td colspan="3" class="border border-gray-300 dark:border-gray-600 px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                å°šç„¡é»å­˜è¨˜éŒ„
                            </td>
                        </tr>
                    `;
                    return;
                }

                attendanceList.innerHTML = records.slice(0, 20).map(record => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 text-sm">${record.timestamp}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3 font-mono">${record.toolId}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-3">${record.toolName}</td>
                    </tr>
                `).join('');
            }
        }

        // === Message Handler ===
        class MessageHandler {
            static show(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }
        }

        // === Theme Management ===
        function initializeTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        // === Search Functionality ===
        function setupSearch(appState) {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                appState.renderToolsList(searchTerm);
            });
        }

        // === Application Initialization ===
        let appState;
        let qrScannerModule;
        let csvModule;
        let attendanceProcessor;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            // Initialize application state
            appState = new AppState();
            
            // Initialize modules
            qrScannerModule = new QRScannerModule(appState);
            csvModule = new CSVModule(appState);
            attendanceProcessor = AttendanceProcessor;
            
            // Setup search
            setupSearch(appState);
            
            // Load sample data for demonstration
            loadSampleData();
            
            console.log('ğŸ“‹ æ•™å…·é»å­˜ç³»çµ±å·²åˆå§‹åŒ–');
        });

        // === Sample Data ===
        function loadSampleData() {
            if (appState.tools.length === 0) {
                const sampleTools = [
                    { id: 'T001', name: 'é¡¯å¾®é¡', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T002', name: 'æŠ•å½±æ©Ÿ', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T003', name: 'æ•¸å­¸æ•™å…·çµ„', attendanceCount: 0, lastAttendance: '' },
                    { id: 'T004', name: 'é«”æ„Ÿå™¨æ', attendanceCount: 0, lastAttendance: '' }
                ];
                appState.setTools(sampleTools);
            }
        }
    </script>
</body>
</html>